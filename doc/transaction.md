## トランザクションとは

DBの作業単位の事。トランザクションによって複数の変更がテーブルに行われた場合に、commitされると全ての変更が完了している事を表して、rollbackすると全ての変更が開始する前の状態に戻っている事を表す

## ACID特性

>ACIDモデルは、ビジネスデータやミッションクリティカルなアプリケーションにとって重要な信頼性の側面を強調する一連のデータベース設計原則です。MySQLには、InnoDBストレージエンジンなどのACIDモデルに忠実なコンポーネントが含まれており、ソフトウェアのクラッシュやハードウェアの故障などの例外的な状況でもデータが破損したり、結果が歪んだりすることがありません。ACIDに準拠した機能に依存している場合、一貫性チェックやクラッシュリカバリーのメカニズムを再発明する必要はありません。追加のソフトウェア安全装置、非常に信頼性の高いハードウェア、または少量のデータ損失や不整合を許容できるアプリケーションがある場合、MySQL の設定を調整して、ACID の信頼性の一部をより高いパフォーマンスやスループットと交換することができます。

MySQLの公式では上記の様に書いています
これらはRDBMSのトランザクション処理が保持しておくべき特性の頭文字をとったもので、InnodbはACID特性に準拠しています

### A (atomicity) 原子性
 - これ以上分解されてはならないという単位の事です。トランザクションが貼られた単位で処理が完全に成功するか、完全に実行前の状態になるというのが保証される粒度の事を言います

 - 関わりが大きい機能としては `commit`, `rollback`, `autocommit`の3つがある
    - commit -> 現在のトランザクションをコミットして、その変更を永続的なものにする
    - rollback -> 現在のトランザクションをロールバックして、その変更を取り消す
    - autocommit - > MySQLではデフォルトで`autocommit=1`が設定されている


#### autocommit=1の場合の例
``` sql
INSERT INTO users (id, name) VALUES (100, 'hoge');
```

の様なSQLを実行した場合に、`commit`を打たなくても自動でcommitされる
これは`auto commit`がデフォルトではONになっているから。

このauto commitを回避するには、`begin`または `start transaction`を使用する事で`autocommit`をOFFにする事ができる

autocommitの設定確認方法

```sql
SELECT @@autocommit;
```

- autocommit=1の場合
    - 明示的に`rollback`などを実行する事はできない
    - 代わりにエラーが発生した場合は、ロールバックされる

- autocommit=1で`begin`や`start transaction`を使った場合
    - 明示的に`rollback`をするとロールバックされる
    - 明示的に`commit`を打たないとcommitされない


 [START TRANSACTION、COMMIT および ROLLBACK ステートメント](https://dev.mysql.com/doc/refman/8.0/ja/commit.html#:~:text=COMMIT%20%E3%81%AF%E3%80%81%E7%8F%BE%E5%9C%A8%E3%81%AE%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3,%E7%84%A1%E5%8A%B9%E3%81%BE%E3%81%9F%E3%81%AF%E6%9C%89%E5%8A%B9%E3%81%AB%E3%81%97%E3%81%BE%E3%81%99%E3%80%82)

### C (Consistency) 一貫性
 - トランザクションの実行によって、常に整合性が保たれている状態である事を保証する事
    - 関わりが大きい機能としては`ダブルライトバッファ`、`クラッシュリカバリ`がある

#### ダブルライトバッファ
- システムのテーブルスペースにデータが保存される前に書き込む領域
- 何のためにあるのか？
    - 実際にページに書き込む際に他のデータを含めて破損させてしまうとデータの完全性を損なうから
    - ダブルライトバッファに書き込んでから、テーブルスペースを書き換えると完全なデータコピーがあるので復元できる

#### クラッシュリカバリ
- InnoDBのクラッシュリカバリには複数ステップが存在します
    - テーブルスペースの探索
        - テーブルスペースの探索をする事で適応されていないデータを確認する
    - REDOログの適応
        - 
    

### I (isolation)
 - 複数実行されているトランザクションから影響を受けない事
 - トランザクション分離レベルによってどのくらい分離するかが定義される
 - MySQLでは4つの分離レベルがある
    - READ UNCOMMITED
        - [ダーティリード]()
    - READ COMMITED
        - [ノンリピータブルリード]()
    - REPETABLE READ
        - [ファントムリード]()
    - SERIALIZABLE

### D (Durability)
 - トランザクションがcommitされた場合、その結果は失われない事を指す


[MySQL公式:  InnoDB および ACID モデル](https://dev.mysql.com/doc/refman/8.0/ja/mysql-acid.html)




